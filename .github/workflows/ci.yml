name: CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  release:
    types: [ created ]
  workflow_dispatch:

env:
  GO_VERSION: '1.21'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: 设置 Go 环境
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}
    
    - name: 获取依赖
      run: go mod download
    
    - name: 运行测试
      run: go test -v ./...
      continue-on-error: true
    
    - name: 构建应用
      env:
        APP_VERSION: ${{ github.ref == 'refs/heads/main' && 'dev' || github.ref_name }}
        BUILD_TIME: ${{ github.event.head_commit.timestamp }}
        GIT_COMMIT: ${{ github.sha }}
      run: |
        go build -ldflags "-X 'main.buildTime=$(date -u +'%Y-%m-%dT%H:%M:%SZ')' -X 'main.gitCommit=${{ github.sha }}' -X 'main.appVersion=${{ github.ref == 'refs/heads/main' && 'dev' || github.ref_name }}'" -o mallback
    
    - name: 上传构建产物
      uses: actions/upload-artifact@v4
      with:
        name: mallback-linux-amd64
        path: mallback
        retention-days: 30

  build-matrix:
    name: 构建多平台
    runs-on: ${{ matrix.os }}
    needs: build
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            GOOS: linux
            GOARCH: amd64
            BINARY: mallback-linux-amd64
          - os: windows-latest
            GOOS: windows
            GOARCH: amd64
            BINARY: mallback-windows-amd64.exe
          - os: macos-latest
            GOOS: darwin
            GOARCH: amd64
            BINARY: mallback-darwin-amd64
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
    
    - name: 设置 Go 环境
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}
    
    - name: 获取依赖
      run: go mod download
    
    - name: 构建 ${{ matrix.BINARY }}
      env:
        GOOS: ${{ matrix.GOOS }}
        GOARCH: ${{ matrix.GOARCH }}
        APP_VERSION: ${{ github.ref == 'refs/heads/main' && 'dev' || github.ref_name }}
        BUILD_TIME: ${{ github.event.head_commit.timestamp }}
        GIT_COMMIT: ${{ github.sha }}
      run: |
        if [ "${{ matrix.GOOS }}" == "windows" ]; then
          go build -ldflags "-X 'main.buildTime=$(date -u +'%Y-%m-%dT%H:%M:%SZ')' -X 'main.gitCommit=${{ github.sha }}' -X 'main.appVersion=${{ github.ref == 'refs/heads/main' && 'dev' || github.ref_name }}'" -o ${{ matrix.BINARY }}
        else
          go build -ldflags "-X 'main.buildTime=$(date -u +'%Y-%m-%dT%H:%M:%SZ')' -X 'main.gitCommit=${{ github.sha }}' -X 'main.appVersion=${{ github.ref == 'refs/heads/main' && 'dev' || github.ref_name }}'" -o ${{ matrix.BINARY }}
        fi
    
    - name: 上传构建产物
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.BINARY }}
        path: ${{ matrix.BINARY }}
        retention-days: 30

  release:
    name: 创建发布版本
    runs-on: ubuntu-latest
    needs: build-matrix
    if: github.event_name == 'release'
    
    steps:
    - name: 下载所有构建产物
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts
    
    - name: 创建发布版本
      uses: softprops/action-gh-release@v1
      with:
        files: ./artifacts/**
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

